---
import Layout from '../layouts/Layout.astro';
import { getBackendUrl } from '../utils/env';

const { tourId } = Astro.params;
const jwt = Astro.cookies.get('jwt')?.value;

if (!jwt) {
    return Astro.redirect('/');
}

const response =
    (await fetch(`${getBackendUrl()}/tour/${tourId}`, {
        credentials: 'include',
    }).then((res) => res.json())) || {};

if (response.status === 'error') {
    return Astro.redirect('/');
}
---

<Layout>
    <section class="section-header">
        <div class="header__hero">
            <div class="header__hero-overlay">&nbsp;</div>
            <img class="header__hero-img" src={`/img/tours/${tour.imageCover}`} alt={tour.name} />
        </div>

        <div class="heading-box">
            <h1 class="heading-primary">
                <span>{tour.name}</span>
            </h1>
            <div class="heading-box__group">
                <div class="heading-box__detail">
                    <svg class="heading-box__icon">
                        <use xlink:href="/img/icons.svg#icon-clock"></use>
                    </svg>
                    <span class="heading-box__text">{tour.duration} days</span>
                </div>
                <div class="heading-box__detail">
                    <svg class="heading-box__icon">
                        <use xlink:href="/img/icons.svg#icon-map-pin"></use>
                    </svg>
                    <span class="heading-box__text">{tour?.startLocation?.description}</span>
                </div>
            </div>
        </div>
    </section>

    <section class="section-description">
        <div class="overview-box">
            <div>
                <div class="overview-box__group">
                    <h2 class="heading-secondary ma-bt-lg">Quick facts</h2>
                    <div class="overview-box__detail">
                        <svg class="overview-box__icon">
                            <use xlink:href="/img/icons.svg#icon-calendar"></use>
                        </svg>
                        <span class="overview-box__label">Next date</span>
                        <span class="overview-box__text">
                            {new Date(tour?.startDates[0]).toLocaleString('en-us', { month: 'long', year: 'numeric' })}
                        </span>
                    </div>
                    <div class="overview-box__detail">
                        <svg class="overview-box__icon">
                            <use xlink:href="/img/icons.svg#icon-trending-up"></use>
                        </svg>
                        <span class="overview-box__label">Difficulty</span>
                        <span class="overview-box__text">{tour?.difficulty}</span>
                    </div>
                    <div class="overview-box__detail">
                        <svg class="overview-box__icon">
                            <use xlink:href="/img/icons.svg#icon-user"></use>
                        </svg>
                        <span class="overview-box__label">Participants</span>
                        <span class="overview-box__text">{tour?.maxGroupSize} people</span>
                    </div>
                    <div class="overview-box__detail">
                        <svg class="overview-box__icon">
                            <use xlink:href="/img/icons.svg#icon-star"></use>
                        </svg>
                        <span class="overview-box__label">Rating</span>
                        <span class="overview-box__text">{tour?.ratingsAverage} / 5</span>
                    </div>
                </div>

                <div class="overview-box__group">
                    <h2 class="heading-secondary ma-bt-lg">Your tour guides</h2>
                    {
                        tour?.guides.map((guide) => (
                            <div class="overview-box__detail">
                                <img class="overview-box__img" src={`/img/users/${guide.photo}`} alt={guide.name} />
                                <span class="overview-box__label">{guide.role}</span>
                                <span class="overview-box__text">{guide.name}</span>
                            </div>
                        ))
                    }
                </div>
            </div>

            <div class="description-box">
                <h2 class="heading-secondary ma-bt-lg">About {tour.name} tour</h2>
                {tour?.description.split('\n').map((paragraph) => <p class="description__text">{paragraph}</p>)}
            </div>
        </div>
    </section>

    <section class="section-pictures">
        {
            tour?.images.map((image, i) => (
                <div class="picture-box">
                    <img
                        class={`picture-box__img picture-box__img--${i + 1}`}
                        src={`/img/tours/${image}`}
                        alt={tour.name}
                    />
                </div>
            ))
        }
    </section>

    <section class="section-map">
        <div id="map" data-locations={JSON.stringify(tour?.locations)}></div>
    </section>

    <section class="section-cta">
        <div class="cta">
            <div class="cta__img cta__img--logo">
                <img src="/img/logo-white.png" alt="Natours logo" />
            </div>
            <img class="cta__img cta__img--1" src={`/img/tours/${tour?.images[1]}`} alt="Tour Picture" />
            <img class="cta__img cta__img--2" src={`/img/tours/${tour?.images[2]}`} alt="Tour Picture" />
            <div class="cta__content">
                <h2 class="heading-secondary">What are you waiting for?</h2>
                <p class="cta__text">
                    {tour?.duration} days. 1 adventure. Infinite memories. Make it yours today!
                </p>

                {
                    tour?.isBooked ? (
                        <button class="btn btn--green span-all-rows" id="book-tour" data-tour-id={tour?.id}>
                            You Already Booked
                        </button>
                    ) : (
                        <button class="btn btn--green span-all-rows" id="book-tour" data-tour-id={tour?.id}>
                            Book tour now!
                        </button>
                    )
                }
            </div>
        </div>
    </section>
</Layout>
